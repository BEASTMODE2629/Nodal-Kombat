<!DOCTYPE HTML>
<html>
    <head>
        <title>Level Test</title>
        <link rel="stylesheet" href="css/leveltest.css" type="text/css">
    </head>
    <body>

	<canvas id="arena" width="800" height="480" />

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript">
	
	
		function SmartImage(src, callback) {
			var that = this;
			this.img = new Image();
			this.src = src;
			this.img.onload = function () {
				////console.log("Loaded " + src);
				callback && callback(that.img);
				SmartImage.queue.splice(SmartImage.queue.indexOf(that), 1);
				if (SmartImage.queue.length === 0) {
					SmartImage.callback();
				}
			};
			this.img.onerror = function () {
				//console.log("Error: Couldn't load image " + src);
			}
			SmartImage.queue.push(this);
		}
		SmartImage.load_all = function(callback) {
			//console.log("Loading all...");
			SmartImage.callback = callback;
			for (var i = 0; i < SmartImage.queue.length; i++) {
				SmartImage.queue[i].img.src = SmartImage.queue[i].src;
			}
		};
		SmartImage.queue = [];
		


		function Platform(img, x, y) {
			this.simg = new SmartImage(img);
			this.x = x;
			this.y = y;
		}
		
	
		function Level(canvas_id) {
			this.background = null;
			this.platforms = [];
			this.w = 0;
			this.h = 0;
		}
		Level.prototype.load = function(name, callback) {
			var that = this,
				url = "levels/" + name + "/";
			
			$.getJSON(url + "data.json", function(data) {
				//console.log("Got the level");
				that.background = new SmartImage(url + data.background);
				that.w = data.horizontal;
				that.h = data.vertical;
				for (var i = 0; i < data.platforms.length; i++) {
					var new_platform = new Platform(url + data.platforms[i].image, data.platforms[i].left, data.platforms[i].top);
					that.platforms.push(new_platform);
				}
				SmartImage.load_all(function() {
					//console.log("Starting loop...");
					window.setInterval(callback, 1000 / 77);
				});
			});
		};


		function View(canvas_id) {
			this.canvas = document.getElementById(canvas_id);
			this.ctx = this.canvas.getContext('2d');
			this.ox = this.canvas.width * .5;
			this.oy = this.canvas.height * .5;
		}
		View.prototype.render = function(level, cam_x, cam_y) {
			var bg = level.background.img,
				ox = this.ox,
				oy = this.oy,
				px = ((cam_x + level.w) / (level.w * 2)),
				py = ((cam_y + level.h) / (level.h * 2)),
				bx = (this.canvas.width - bg.width) * px,
				by = (this.canvas.height - bg.height) * py;
			this.ctx.drawImage(bg, bx, by);
			for (var i = 0; i < level.platforms.length; i++) {
				var plat = level.platforms[i];
				this.ctx.drawImage(plat.simg.img, ox + plat.x - cam_x, oy + plat.y - cam_y);
			}
		}
		
		
		function Keyboard() {
			var that = this;
			
			this.map = {'38':'up', '39':'right', '40':'down', '37':'left'};
				
			$(document).keydown(function (event) {
				if (that.map[event.which]) {
					that[that.map[event.which]] = true;
				}
				else {
					//console.log(event.which);
					return true;
				}
				return false;
			});
			
			$(document).keyup(function (event) {
				if (that.map[event.which]) {
					that[that.map[event.which]] = false;
				}		
			});	
		}


	
		var level = new Level();
		var view = new View('arena');
		var keyboard = new Keyboard();
		
		var camera_x = 0,
			camera_y = 0;
		var cdx = 0,
			cdy = 0;
		
		function main() {
			cdx = (keyboard.left) ? cdx - 2 : cdx;
			cdx = (keyboard.right) ? cdx + 2 : cdx;
			cdy = (keyboard.up) ? cdy - 2 : cdy;			
			cdy = (keyboard.down) ? cdy + 2 : cdy;
			camera_x += cdx;
			camera_y += cdy;
			cdx *= .9;
			cdy *= .9;
			if (camera_x < -level.w) {
				camera_x = -level.w;
			}
			else if(camera_x > level.w) {
				camera_x = level.w;
			}
			if (camera_y < -level.h) {
				camera_y = level.y;
			}
			else if(camera_y > level.h) {
				camera_y = level.h;
			}
			view.render(level, camera_x, camera_y);
		}
		
		level.load('test_level', main);
	
	
	</script>

	</body>
</html>